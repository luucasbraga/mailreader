FROM tomcat:jre21-temurin-jammy

ENV JAVA_OPTS="-Xmx3g"

ENV TZ=America/Sao_Paulo
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Instalação de dependências adicionais + Python3 + Chromium/ChromeDriver para Selenium
RUN apt-get update && \
    apt-get install -y tesseract-ocr tesseract-ocr-por poppler-utils pdfcrack \
                       python3 python3-pip python3-venv \
                       wget gnupg unzip curl \
                       # Dependências necessárias para Chromium
                       ca-certificates fonts-liberation libappindicator3-1 \
                       libasound2 libatk-bridge2.0-0 libatk1.0-0 libc6 \
                       libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 \
                       libgbm1 libgcc1 libglib2.0-0 libgtk-3-0 libnspr4 \
                       libnss3 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 \
                       libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 \
                       libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 \
                       libxrender1 libxss1 libxtst6 lsb-release xdg-utils && \
    # Baixar e instalar Chromium diretamente do repositório oficial
    CHROMIUM_VERSION=$(curl -s "https://googlechromelabs.github.io/chrome-for-testing/last-known-good-versions-with-downloads.json" | grep -oE '"version":\s*"[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+"' | head -1 | grep -oE '[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+') && \
    if [ -z "$CHROMIUM_VERSION" ]; then \
        CHROMIUM_VERSION="131.0.6778.85"; \
    fi && \
    wget -O /tmp/chromium-linux64.zip "https://storage.googleapis.com/chrome-for-testing-public/${CHROMIUM_VERSION}/linux64/chrome-linux64.zip" && \
    unzip /tmp/chromium-linux64.zip -d /tmp/ && \
    mv /tmp/chrome-linux64 /opt/chromium && \
    chmod +x /opt/chromium/chrome && \
    ln -s /opt/chromium/chrome /usr/local/bin/chromium && \
    # Baixar e instalar ChromeDriver
    wget -O /tmp/chromedriver-linux64.zip "https://storage.googleapis.com/chrome-for-testing-public/${CHROMIUM_VERSION}/linux64/chromedriver-linux64.zip" && \
    unzip /tmp/chromedriver-linux64.zip -d /tmp/ && \
    mv /tmp/chromedriver-linux64/chromedriver /usr/local/bin/chromedriver && \
    chmod +x /usr/local/bin/chromedriver && \
    rm -rf /tmp/chromium* /tmp/chromedriver* && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Copie o WAR da aplicação para o container
WORKDIR /usr/local/tomcat/webapps
RUN chmod -R 777 /usr/local/tomcat/webapps
COPY /target/mailreader.war /usr/local/tomcat/webapps/mailreader.war

# Copie os scripts Python para o container
RUN mkdir -p /usr/local/tomcat/webapps/python-scripts
COPY python-scripts/*.py /usr/local/tomcat/webapps/python-scripts/
RUN chmod +x /usr/local/tomcat/webapps/python-scripts/*.py

# Instalar dependências Python (Selenium, requests e beautifulsoup4)
RUN pip3 install selenium requests beautifulsoup4

ENV SPRING_PROFILES_ACTIVE=homol

# Exponha a porta
EXPOSE 8080
